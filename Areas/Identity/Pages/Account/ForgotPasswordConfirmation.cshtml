@page
@model ForgotPasswordConfirmation
@{
    ViewData["Title"] = "Confirmación de recuperación de contraseña";

    // Extraer el dominio del correo
    var emailParts = Model.Email?.Split('@');
    var emailDomain = emailParts?.Length == 2 ? emailParts[1].ToLower() : "";

    // Determinar la URL del proveedor de correo
    var emailProviderUrl = emailDomain switch
    {
        "gmail.com" => "https://mail.google.com/mail/",
        "outlook.com" or "hotmail.com" => "https://outlook.live.com/mail/",
        "yahoo.com" => "https://mail.yahoo.com/",
        _ => $"https://{emailDomain}" // Para otros proveedores
    };

    // Nombre amigable del proveedor
    var providerName = emailDomain switch
    {
        "gmail.com" => "Gmail",
        "outlook.com" or "hotmail.com" => "Outlook",
        "yahoo.com" => "Yahoo Mail",
        _ => emailDomain // Para otros proveedores
    };
}

<div class="container">
    <div class="row justify-content-center align-items-center h-100">
        <div class="col-lg-6">
            <div class="card shadow-lg rounded-4 border-0" style="max-height: 80vh; overflow-y: auto;">
                <div class="card-body p-4">
                    <div class="text-center mb-3">
                        <img src="~/favicon_io/android-chrome-192x192.png" alt="logo"
                            style="height: 100px; width: auto;" class="img-fluid" />
                        <h4 class="fw-bold mb-2" style="color: #0077cc;">@ViewData["Title"]</h4>
                        <p class="text-muted small">Hemos procesado tu solicitud de recuperación</p>
                    </div>

                    <div class="alert alert-success d-flex align-items-center py-2" role="alert">
                        <i class="fas fa-check-circle me-2" style="font-size: 1.2rem;"></i>
                        <div class="small">
                            Hemos enviado un enlace de recuperación a tu correo electrónico
                        </div>
                    </div>

                    <div class="mb-3 p-3 bg-light rounded-3">
                        <p class="mb-2 small">
                            <i class="fas fa-info-circle me-2" style="color: #0077cc;"></i>
                            <strong>Por favor revisa:</strong>
                        </p>
                        <ul class="ps-3 small">
                            <li>Tu bandeja de entrada principal</li>
                            <li>La carpeta de spam o correo no deseado</li>
                            <li>Que el correo electrónico sea el correcto</li>
                        </ul>
                    </div>

                    <!-- Contenedor de la cuenta regresiva -->
                    <div id="countdown-container" class="alert alert-warning text-center mb-3 py-2">
                        <div class="d-flex justify-content-center align-items-center">

                            <div>
                                <span id="countdown" class="fw-bold"></span>
                                <div class="small">Tiempo restante para usar el enlace</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje que aparecerá cuando expire el tiempo (inicialmente oculto) -->
                    <div id="expired-message" class="alert alert-danger text-center mb-3 py-2" style="display: none;">
                        <div class="d-flex flex-column align-items-center">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <span class="fw-bold">¡El tiempo ha expirado!</span>
                            </div>
                            <div class="small mb-2">El enlace de recuperación ya no es válido</div>
                            <a asp-page="./ForgotPassword" class="btn btn-sm btn-danger">
                                <i class="fas fa-envelope me-1"></i>
                                Ingrese su correo nuevamente
                            </a>
                        </div>
                    </div>

                    <div class="d-grid gap-2 col-md-8 mx-auto mb-3 justify-content-center">
                        @if (!string.IsNullOrEmpty(Model.Email))
                        {
                            <a href="@emailProviderUrl" target="_blank" class="btn btn-primary btn-sm">
                                <i class="fas fa-envelope me-2"></i>
                                Abrir @providerName
                            </a>
                        }
                        else
                        {
                            <a href="https://mail.google.com/mail/" target="_blank" class="btn btn-primary btn-sm">
                                <i class="fas fa-envelope me-2"></i>
                                Abrir correo
                            </a>
                        }

                        <a asp-page="./Login" class="btn btn-sm btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver al inicio de sesión
                        </a>
                    </div>


                    <div class="mt-4 pt-2 border-top text-center text-muted small">
                        <p class="mb-0">Si continúas con problemas, contacta con <a href="#"
                                class="text-primary">soporte técnico</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Función para la cuenta regresiva
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            const countdownContainer = document.getElementById('countdown-container');
            const expiredMessage = document.getElementById('expired-message');

            // Obtenemos el email del modelo
            const userEmail = '@Model.Email';

            if (!userEmail) {
                console.error("No se encontró email en el modelo");
                return;
            }

            // Clave única para almacenar en localStorage (incluye el email)
            const storageKey = `tokenExpirationTime_${userEmail}`;

            // 1 hora en segundos
            const tokenDuration = 3600;

            // Obtener el tiempo almacenado o inicializar uno nuevo
            let expirationTime = localStorage.getItem(storageKey);

            if (!expirationTime) {
                // Si no hay tiempo almacenado, crear uno nuevo (hora actual + 1 hora)
                expirationTime = Math.floor(Date.now() / 1000) + tokenDuration;
                localStorage.setItem(storageKey, expirationTime);
            } else {
                expirationTime = parseInt(expirationTime);
            }

            const timer = setInterval(function () {
                const now = Math.floor(Date.now() / 1000);
                let timeLeft = expirationTime - now;

                // Si el tiempo ya expiró
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = "00:00:00";
                    countdownContainer.style.display = 'none';
                    expiredMessage.style.display = 'block';
                    localStorage.removeItem(storageKey); // Limpiar el almacenamiento
                    return;
                }

                // Calcular horas, minutos y segundos
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;

                // Actualizar el contador
                countdownElement.textContent =
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            }, 1000);
        }

        // Iniciar la cuenta regresiva cuando la página cargue
        document.addEventListener('DOMContentLoaded', startCountdown);
    </script>
}