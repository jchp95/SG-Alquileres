@page "{token?}"
@model ResetPasswordModel
@{
    ViewData["Title"] = "Restablecer contraseña";
}

<div class="container">
    <div class="row justify-content-center align-items-center h-100">
        <div class="col-lg-6">
            <div class="card shadow-lg rounded-4 border-0" style="max-height: 80vh; overflow-y: auto;">
                <div class="card-body p-4">
                    <div class="text-center mb-3">
                        <img id="logoEmpresa" src="@Url.Action("GetLogo", "Empresa")" alt="LOGO" class="logo-navbar"
                            style="height: 60px; width: auto;"
                            onerror="this.style.display='none'; document.getElementById('altLogo').style.display='inline';" />

                        <span id="altLogo" class="fw-bold text-dark" style="display: none;">LOGO</span>
                        <h4 class="fw-bold mb-2" style="color: #0077cc;">@ViewData["Title"]</h4>
                        <p class="text-muted small">Ingresa tu nueva contraseña</p>
                    </div>

                    <form method="post" id="resetPasswordForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger py-2" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                        </div>

                        <input asp-for="Input.Code" type="hidden" />

                        <div class="mb-3">
                            <label asp-for="Input.Email" class="form-label small fw-bold">Correo electrónico</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input asp-for="Input.Email" class="form-control" autocomplete="username"
                                    aria-required="true" placeholder="ejemplo@dominio.com" />
                            </div>
                            <span asp-validation-for="Input.Email" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.Password" class="form-label small fw-bold">Nueva contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="Input.Password" class="form-control" autocomplete="new-password"
                                    aria-required="true" placeholder="Ingresa tu nueva contraseña" />
                            </div>
                            <span asp-validation-for="Input.Password" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Input.ConfirmPassword" class="form-label small fw-bold">Confirmar
                                contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password"
                                    aria-required="true" placeholder="Confirma tu nueva contraseña" />
                            </div>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt me-2"></i>
                                Restablecer contraseña
                            </button>
                        </div>
                    </form>

                    <div class="mt-3 text-center">
                        <a asp-page="./Login" class="mb-1">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver al inicio de sesión
                        </a>
                    </div>

                    <div class="mt-4 pt-2 border-top text-center text-muted small">
                        <p class="mb-0">¿Necesitas ayuda? Contacta con <a href="#" class="text-primary">soporte
                                técnico</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    @if (TempData["ResetPasswordSuccess"] != null)
    {
        <script>

            const successMessage = '@TempData["ResetPasswordSuccess"]';
            if (successMessage) {
                const userEmail = '@Model.Input.Email';
                if (userEmail) {
                    const storageKey = `tokenExpirationTime_${userEmail}`;
                    localStorage.removeItem(storageKey);
                }
            }

            Swal.fire({
                title: '¡Contraseña actualizada!',
                text: '@Html.Raw(TempData["ResetPasswordSuccess"])',
                icon: 'success',
                confirmButtonText: 'OK',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // Limpiar el token del localStorage antes de redirigir
                    const userEmail = '@Model.Input.Email';
                    if (userEmail) {
                        const storageKey = `tokenExpirationTime_${userEmail}`;
                        localStorage.removeItem(storageKey);
                    }
                    window.location.href = '/'; // Redirige a Home
                }
            });
        </script>
    }
}