@model Alquileres.Models.Empresa

@{
    ViewData["Title"] = "Administrar Empresa";
    var successMessage = TempData["SuccessMessage"] as string;
}


@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success" id="successMessage">
        @successMessage
    </div>
    // Limpiar el mensaje después de mostrarlo (TempData ya lo hace, pero por si acaso)
    TempData["SuccessMessage"] = null;
}


<form id="empresaForm" asp-action="GuardarDatosEmpresa" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div class="row justify-content-center m-0 p-0">
        <input type="hidden" name="IdEmpresa" value="@Model.IdEmpresa" />
        <!-- Información básica -->
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Rnc">RNC</label>
                <input asp-for="Rnc" class="form-control" maxlength="18" />
                <span asp-validation-for="Rnc" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Nombre">Nombre de la Empresa</label>
                <input asp-for="Nombre" class="form-control" maxlength="250" />
                <span asp-validation-for="Nombre" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Slogan">Eslogan de la Empresa</label>
                <input asp-for="Slogan" class="form-control" maxlength="250" />
                <span asp-validation-for="Slogan" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Direccion">Dirección</label>
                <input asp-for="Direccion" class="form-control" maxlength="250" />
                <span asp-validation-for="Direccion" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Telefonos">Teléfonos</label>
                <input asp-for="Telefonos" class="form-control telefono-input" maxlength="14" />
                <span asp-validation-for="Telefonos" class="text-danger"></span>
            </div>
            <!-- Select para Comprobantes -->
            <div class="form-group">
                <label class="control-label">Tipos de comprobantes</label>
                <select asp-for="TipoComprobantePorDefecto" class="form-control"
                    asp-items="ViewBag.TipoComprobantePorDefecto"></select>
                <span asp-validation-for="TipoComprobantePorDefecto" class="text-danger"></span>
            </div>


            <div class="form-group form-switch">
                <input asp-for="ActivarCobroRapido" class="form-check-input" id="ActivarCobroRapido" />
                <label class="form-check-label" for="ActivarCobroRapido">Activar cobro rápido</label>
            </div>

            <div>
             <button type="submit" class="btn btn-primary">Guardar Información</button>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                <h5 class="mb-0">Imágenes de la Empresa</h5>
                </div>
            <div class="card-body">

                    <!-- Componente reutilizable -->
                    @* Puedes convertir este bloque en un partial si gustas *@
                    @{
                        var imagenes = new[]
                        {
                            new { Id = "logo", Label = "Logo de la Empresa", ModelProp = Model?.Logo, UrlAction = "GetLogo" },
                            new { Id = "fondo", Label = "Imagen de Fondo", ModelProp = Model?.Fondo, UrlAction = "GetFondo" },
                            new { Id = "qrRedes", Label = "QR Redes Sociales", ModelProp = Model?.CodigoQrRedes, UrlAction = "GetQrRedes" },
                            new { Id = "qrWeb", Label = "QR Sitio Web", ModelProp = Model?.CodigoQrWeb, UrlAction = "GetQrWeb" }
                        };
                    }

                    @foreach (var img in imagenes)
                    {
            <div class="mb-4">
              <label class="form-label fw-semibold">@img.Label</label>
              <div class="row g-2 align-items-center">
                <div class="col-12 col-sm-8">
                  <input type="file" id="@($"{img.Id}File")" name="@($"{img.Id}File")" class="form-control"
                         accept="image/png, image/jpeg" onchange="previewImage(event, '@($"{img.Id}Preview")')" />
                  <button type="button" class="btn btn-outline-danger btn-sm mt-2"
                          onclick="clearImage('@($"{img.Id}File")', '@($"{img.Id}Preview")', '@($"{img.Id}Actual")')">
                    Quitar Imagen
                  </button>
                  <span class="text-danger d-block mt-1" id="@($"{img.Id}FileError")"></span>
                </div>
                <div class="col-12 col-sm-4 text-center m-0">
                  <img id="@($"{img.Id}Preview")" class="img-thumbnail mt-2" style="max-height: 100px; display: none;" />
                                    @if (img.ModelProp != null && ((byte[])img.ModelProp).Length > 0)
                                    {
                        <img src="@Url.Action(img.UrlAction, "Empresa")?v=@DateTime.Now.Ticks"
                             class="img-thumbnail mt-2" style="max-height: 100px;" id="@($"{img.Id}Actual")" />
                                    }
                </div>
              </div>
            </div>
                    }
        </div>
    </div>
</div>


    <div id="formErrors" class="text-danger mb-3"></div>

    
    <div id="loadingIndicator" class="spinner-border text-primary d-none" role="status">
        <span class="sr-only">Cargando...</span>
    </div>
    <div id="successMessage" class="alert alert-success mt-3 d-none">Los cambios se guardaron correctamente.</div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function previewImage(event, previewId) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function () {
                const img = document.getElementById(previewId);
                img.src = reader.result;
                img.style.display = 'block'; // Mostrar la imagen
            }
            if (file) {
                reader.readAsDataURL(file);
            }
        }

        // Función para aplicar máscaras a los teléfonos
        function applyPhoneMasks() {
            $('.telefono-input').inputmask({
                mask: '(999) 999-9999',
                placeholder: '',
                showMaskOnHover: false,
                clearIncomplete: true,
                autoUnmask: true,
                showMaskOnFocus: false,
                onBeforeMask: function (value, opts) {
                    return value.replace(/[^0-9]/g, '');
                }
            });
        }


        $(document).ready(function () {
            applyPhoneMasks();
            // No forzar el switch, dejar que el valor lo determine el modelo
        });

        function clearImage(fileInputId, previewImgId, actualImgId = null) {
            const fileInput = document.getElementById(fileInputId);
            const previewImg = document.getElementById(previewImgId);
            const actualImg = actualImgId ? document.getElementById(actualImgId) : null;

            if (fileInput) fileInput.value = '';
            if (previewImg) {
                previewImg.src = '';
                previewImg.style.display = 'none';
           
            if (actualImg) actualImg.style.display = 'none';

            // Opcional: agregar input oculto para indicar eliminación al backend
            let hiddenInputId = 'delete_' + fileInputId;
            let hiddenInput = document.getElementById(hiddenInputId);
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = hiddenInputId;
                hiddenInput.id = hiddenInputId;
                hiddenInput.value = 'true';
                document.getElementById('empresaForm').appendChild(hiddenInput);
            }
        }

    </script>
}
