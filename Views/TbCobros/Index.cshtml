@using Alquileres.Models
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@using Microsoft.AspNetCore.Identity
@model IEnumerable<dynamic>

@{
    var tipoCobro = ViewData["TipoCobro"]?.ToString().ToLower() ?? "rapido";
    var tituloPagina = tipoCobro == "Rapido" ? "Cobro rapido" :
    tipoCobro == "Detallado" ? "Cobro detallado" :
    "Gestion de cobro";

    ViewData["Title"] = tituloPagina;
}


@section Styles {
    <link rel="stylesheet" href="~/css/detalles-cobro.css" asp-append-version="true" />
    <style>
        #welcomeMessage {
            transition: all 0.3s ease;
        }

        .badge {
            font-size: 0.85rem;
        }

        .payment-method-badge {
            font-size: 0.8rem;
            padding: 0.35em 0.65em;
        }

        .card-header {
            font-weight: 600;
        }
    </style>
}

<!-- Elemento oculto para exponer tipoReporte -->
<div id="tipoCobro" data-tipocobro="@tipoCobro" hidden></div>

<div class="container-fluid mt-4">
    <!-- Encabezado y resumen en una misma fila 
    <div class="row align-items-start mb-4 g-3">
     Botones de acción
        @if (tipoCobro != "rapido")
        {
            <div class="col-12 col-md-auto order-1 order-md-1">
                <div class="btn-group" role="group">
                    <button id="createCobro" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i> Cobro detallado
                    </button>
                    <button id="createCobroRapido" class="btn btn-secondary btn-sm">
                        <i class="fas fa-plus me-1"></i> Cobro rápido
                    </button>
                    <button id="loadCobros" class="btn btn-danger btn-sm">
                        <i class="fas fa-search me-1"></i> Consultar
                    </button>
                </div>
            </div>
        } -->

        <!-- Resumen compacto con degradados -->
        @if (tipoCobro != "rapido") 
        {
            <div class="col-12 col-md order-2 order-md-2">
            <div class="d-flex flex-wrap gap-2 justify-content-end card-wrapper">
                @if (SignInManager.IsSignedIn(User))
                {
                    var currentUser = await UserManager.GetUserAsync(User);
                    var isAdmin = currentUser != null && await UserManager.IsInRoleAsync(currentUser,
                    AppConstants.AdministratorRole);
                    var hasPermission = currentUser != null && (await AuthorizationService.AuthorizeAsync(User,
                    "Permissions.Cobros.VerEstadoCobro")).Succeeded;

                    if (isAdmin || hasPermission)
                    {
                        <div class="card border-0 shadow-sm small-card text-white text-center px-3 py-2 bg-gradient-hoy">
                            <h6 class="mb-1">Hoy</h6>
                            <div class="fw-bold h6 mb-0" id="todayAmount">0.00</div>
                        </div>
                        <div class="card border-0 shadow-sm small-card text-white text-center px-3 py-2 bg-gradient-mes">
                            <h6 class="mb-1">Este Mes</h6>
                            <div class="fw-bold h6 mb-0" id="monthAmount">0.00</div>
                        </div>
                    }
                }

                <div class="card border-0 shadow-sm small-card text-white text-center px-3 py-2 bg-gradient-pendientes">
                    <h6 class="mb-1">Pendientes</h6>
                    <div class="fw-bold h6 mb-0" id="pendingAmount">0.00</div>
                </div>
                <div class="card border-0 shadow-sm small-card text-white text-center px-3 py-2 bg-gradient-vencidos">
                    <h6 class="mb-1">Vencidos</h6>
                    <div class="fw-bold h6 mb-0" id="overdueAmount">0.00</div>
                </div>
            </div>
        </div>
        }
    </div>

    <div id="vistaSeleccionada" data-vista="@ViewData["Vista"]"></div>

    <!-- Contenedor para toasts -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11"></div>

    <!-- Spinner superpuesto -->
    <div id="loadingSpinner" class="overlay-spinner" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-dark">Procesando su solicitud...</p>
    </div>

    <!-- Contenedor principal de datos -->
    <div id="dataTableContainer" class="welcomeMessage" style="display: none;"></div>

    <!-- Mensaje inicial cuando no hay datos visibles 
    <div id="welcomeMessage" class="text-center py-5">
        <i class="fas fa-cash-register fa-4x text-muted mb-4"></i>
        <h4 class="text-secondary">Gestión de Cobros</h4>
        <p class="mb-0 text-muted small">
            Gestione cobros, recibos, conciliaciones y comprobantes desde un solo lugar.
        </p>
    </div>-->
</div>

<!-- Modal para el ticket -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="ticketModalLabel">Ticket de Cobro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="ticketContent" class="ticket-80mm">
                    <!-- Contenido del ticket (se mantiene igual que en tu versión original) -->
                    <div class="header-info">
                        <div class="logo-empresa-ticket"></div>
                        <div class="info-row">
                            <span class="info-label">NOMBRE<span>:</span></span>
                            <span class="info-value nombre"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">DIRECCIÓN<span>:</span></span>
                            <span class="info-value direccion"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">TELÉFONO<span>:</span></span>
                            <span class="info-value telefono"></span>
                        </div>
                        <div class="info-row rnc-container">
                            <span class="info-label">RNC<span>:</span></span>
                            <span class="info-value rnc"></span>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="item-content-large-factura">
                        <span class="label tipoComprobante"></span>
                    </div>
                    <div class="item-content ncf-container">
                        <span class="label me-2">NCF:</span>
                        <span class="ncf"></span>
                    </div>
                    <div class="item-content fecha-vencimiento">
                        <span class="label me-2">FECHA VENCIMIENTO:</span>
                        <span class="fncf-vence"></span>
                    </div>

                    <div class="divider"></div>

                    <div class="item-content">
                        <span class="label me-2">FECHA EMISIÓN:</span>
                        <span class="fecha-hora"></span>
                    </div>
                    <div class="item-content-cliente">
                        <span class="label-RZC me-2 fw-bold">RAZÓN SOCIAL CLIENTE:</span>
                        <span class="cliente"></span>
                    </div>
                    <div class="item-content">
                        <span class="label me-2">INMUEBLE:</span>
                        <span class="inmueble"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content">
                        <span class="label me-2">NO. COBRO:</span>
                        <span class="noCobro"></span>
                    </div>
                    <div class="item-content-large">
                        <span class="label-concepto me-2 fw-bold">CONCEPTO:</span>
                        <span class="concepto"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content-number">
                        <span class="label">SUBTOTAL:</span>
                        <span class="subtotal"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">CARGOS:</span>
                        <span class="cargos"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">MORA COBRADA:</span>
                        <span class="mora"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">DESCUENTO:</span>
                        <span class="descuento"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">TOTAL:</span>
                        <span class="total"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content-number">
                        <span class="label">EFECTIVO:</span>
                        <span class="efectivo"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">TRANSFERENCIA:</span>
                        <span class="transferencia"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">TARJETA:</span>
                        <span class="tarjeta"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">CHEQUE:</span>
                        <span class="cheque"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">DEPÓSITO:</span>
                        <span class="deposito"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">MONTO NOTA CRÉDITO:</span>
                        <span class="montoNotaCredito"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">NO. NOTA CRÉDITO:</span>
                        <span class="noNotaCredito"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">DÉBITO AUTOMÁTICO:</span>
                        <span class="debitoAutomatico"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content-number">
                        <span class="label">EFECTIVO RECIBIDO:</span>
                        <span class="value numeric-display efectivo-recibido"></span>
                    </div>
                    <div class="item-content-number">
                        <span class="label">CAMBIO:</span>
                        <span class="value numeric-display cambio"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content-resto">
                        <span class="resto"></span>
                    </div>

                    <div class="divider"></div> <!-- Linea divisora-->

                    <div class="item-content">
                        <span class="label me-2">USUARIO:</span>
                        <span class="usuario"></span>
                    </div>

                    <div class="item-content-image">
                        <span class="qr"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="imprimirTicket">Imprimir</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/cobros.js" asp-append-version="true"></script>

    <script>
        $(function () {
            // Oculta el mensaje de bienvenida cuando se hace clic en cualquier botón
            $('.btn-group button').click(function () {
                $('#welcomeMessage').fadeOut(300);
            });

            function cargarResumenCobros() {
                $.ajax({
                    url: '@Url.Action("GetResumenCobros", "TbCobros")',
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            $('#todayAmount').text(formatCurrency(response.hoy));
                            $('#monthAmount').text(formatCurrency(response.mes));
                            $('#pendingAmount').text(formatCurrency(response.pendientes));
                            $('#overdueAmount').text(formatCurrency(response.vencidas));

                            if (response.vencidas > 0) {
                                $('#overdueAmount').addClass('text-danger');
                            }
                        } else {
                            mostrarError(response.message);
                        }
                    },
                    error: function (xhr) {
                        mostrarError("Error al cargar el resumen: " + xhr.statusText);
                    }
                });
            }

            function formatCurrency(amount) {
                return 'RD$ ' + parseFloat(amount || 0)
                    .toFixed(2)
                    .replace(/\d(?=(\d{3})+\.)/g, '$&,');
            }

            function mostrarError(mensaje) {
                console.error(mensaje);
            }

            // Cargar resumen siempre
            cargarResumenCobros();

            // Cargar la vista correcta
            const vista = document.getElementById("vistaSeleccionada").dataset.vista;
            const tipoCobro = '@tipoCobro'.toLowerCase();

            if (vista === "lista") {
                cargarTablaCobro();
            } else if (tipoCobro === "detallado") {
                cargarVistaCrearCobro();
            } else {
                cargarVistaCrearCobroRapido();
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('staticBackdrop');
            if (modal && window.innerWidth <= 767) {
                modal.setAttribute('data-bs-backdrop', 'false');
            }
        });
    </script>
}

