@model IEnumerable<Alquileres.Models.CuentaPorCobrarViewModel>

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="mb-1"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>Cuentas por Cobrar</h2>
            <p class="text-muted mb-0">Gestión de cuentas pendientes de cobro</p>
        </div>
    </div>

    <!-- Card de Filtros -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <div
                class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
                <h5 class="card-title mb-0"><i class="fas fa-filter me-2 text-primary"></i>Filtros Avanzados</h5>
                <div class="d-flex gap-2 w-100 w-lg-auto">
                    <button id="btnAplicarFiltros" class="btn btn-primary flex-grow-1 flex-lg-grow-0">
                        <i class="fas fa-filter me-1"></i> Filtrar
                    </button>
                    <button id="btnResetFiltros" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>

            <div class="row g-3">
                <!-- Filtro por inquilino -->
                <div class="col-md-3">
                    <label for="filtroInquilino" class="form-label small text-muted mb-1">Inquilino</label>
                    <input type="text" id="filtroInquilino" class="form-control" placeholder="Buscar por inquilino">
                </div>

                <!-- Filtro por estado -->
                <div class="col-md-3">
                    <label for="filtroEstado" class="form-label small text-muted mb-1">Estado</label>
                    <select class="form-select" id="filtroEstado">
                        <option value="" selected>Todos</option>
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>

                <!-- Filtro por período -->
                <div class="col-md-3">
                    <label for="filtroPeriodo" class="form-label small text-muted mb-1">Período</label>
                    <select id="filtroPeriodo" class="form-select">
                        <option value="">Todos</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Quincenal">Quincenal</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>

                <!-- Filtro por tipo de fecha -->
                <div class="col-md-3">
                    <label for="filtroTipoFecha" class="form-label small text-muted mb-1">Tipo de Fecha</label>
                    <select id="filtroTipoFecha" class="form-select">
                        <option value="5">Fecha Inicio</option>
                        <option value="7">Próxima Cuota</option>
                    </select>
                </div>

                <!-- Filtro por fecha desde -->
                <div class="col-md-6">
                    <label for="min" class="form-label small text-muted mb-1">Fecha desde</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent">
                            <i class="far fa-calendar text-muted"></i>
                        </span>
                        <input type="text" class="form-control" id="min" placeholder="DD/MM/AAAA">
                        <button class="btn btn-outline-secondary" type="button" id="min-clear">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtro por fecha hasta -->
                <div class="col-md-6">
                    <label for="max" class="form-label small text-muted mb-1">Fecha hasta</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent">
                            <i class="far fa-calendar text-muted"></i>
                        </span>
                        <input type="text" class="form-control" id="max" placeholder="DD/MM/AAAA">
                        <button class="btn btn-outline-secondary" type="button" id="max-clear">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card de Resultados -->
    <div class="card border-0 shadow-sm px-4 py-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="cuentasPorCobrarTable" class="table table-hover align-middle mb-0 table-responsive">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Id CxC</th>
                            <th class="ps-4">Inquilino</th>
                            <th class="text-end pe-3">Monto</th>
                            <th class="text-center">Días de Gracia</th>
                            <th class="text-center">Tasa de Mora</th>
                            <th class="text-center">Fecha Inicio</th>
                            <th class="text-center">Período</th>
                            <th class="text-center">Próxima Cuota</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Notas</th>
                            <th class="text-center">Estado CxC</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    @item.FidCuenta
                                </td>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="ms-3">
                                            <p class="fw-bold mb-0">@item.InquilinoNombre</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end pe-3 fw-bold">
                                    @item.Fmonto.ToString("N2", new System.Globalization.CultureInfo("es-DO"))
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                        @item.FdiasGracia
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning bg-opacity-10 text-warning">
                                        @item.FtasaMora%
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">
                                        @item.FfechaInicio.ToString("dd/MM/yyyy")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info bg-opacity-10 text-info">
                                        @item.NombrePeriodoPago
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (item.FfechaProxCuota.HasValue)
                                    {
                                        <span class="badge bg-primary bg-opacity-10 text-primary">
                                            @item.FfechaProxCuota.Value.ToString("dd/MM/yyyy")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-light text-muted">N/A</span>
                                    }
                                </td>
                                <td>
                                    <span
                                        class="badge @(item.Factivo ? "bg-success bg-opacity-10 text-success" : "bg-danger bg-opacity-10 text-danger")"
                                        data-estado="@(item.Factivo ? "1" : "0")">
                                        @(item.Factivo ? "Activo" : "Inactivo")
                                    </span>
                                </td>
                                <td class="text-center">
                                    @item.Fnota
                                </td>
                                <td class="text-center">
                                    <span class="badge 
                                        @(item.Fstatus == 'N' ? "bg-primary bg-opacity-10 text-primary" : 
                                        item.Fstatus == 'S' ? "bg-success bg-opacity-10 text-success" : 
                                        "bg-warning bg-opacity-10 text-warning")">
                                        @item.EstadoDescripcion
                                    </span>
                                </td>
                                <td class="text-center pe-4">
                                    <div class="d-flex justify-content-center gap-2">
                                        @if (item.Fstatus == 'S')
                                        {
                                            <button class="btn btn-sm btn-outline-primary" disabled
                                                title="Editar (Cuenta Salda)">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" disabled
                                                title="Cancelar CxC (Cuenta Salda)">
                                                <i class="fas fa-times-circle"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" disabled
                                                title="Desactivar (Cuenta Salda)">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            @if (item.Factivo)
                                            {
                                                <!-- Cuenta Activa - Mostrar botones normales -->
                                                <a href="javascript:void(0);" class="btn btn-sm btn-outline-primary editCxC"
                                                    data-id="@item.FidCuenta" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="post" class="d-inline cancelarCxCForm">
                                                    <input type="hidden" name="cuentaId" value="@item.FidCuenta" />
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        title="Cancelar CxC">
                                                        <i class="fas fa-times-circle"></i>
                                                    </button>
                                                </form>
                                                <form asp-action="CambiarEstado" method="post" class="d-inline cambiarEstadoForm">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@item.FidCuenta" />
                                                    <button type="submit"
                                                        class="btn btn-sm @(item.Factivo ? "btn-outline-secondary" : "btn-outline-success")"
                                                        title="@(item.Factivo ? "Desactivar" : "Activar")">
                                                        <i class="fas @(item.Factivo ? "fa-ban" : "fa-undo")"></i>
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <!-- Cuenta Inactiva - Solo botón de activar -->
                                                <button class="btn btn-sm btn-outline-primary" disabled title="Editar (Inactivo)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" disabled
                                                    title="Cancelar CxC (Inactivo)">
                                                    <i class="fas fa-times-circle"></i>
                                                </button>
                                                <form asp-action="CambiarEstado" method="post" class="d-inline cambiarEstadoForm">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@item.FidCuenta" />
                                                    <button type="submit"
                                                        class="btn btn-sm @(item.Factivo ? "btn-outline-secondary" : "btn-outline-success")"
                                                        title="@(item.Factivo ? "Desactivar" : "Activar")">
                                                        <i class="fas @(item.Factivo ? "fa-ban" : "fa-undo")"></i>
                                                    </button>
                                                </form>
                                            }
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Anulación -->
<div class="modal fade" id="confirmCancelarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 bg-danger text-white">
                <h5 class="modal-title">Confirmar Cancelación de CxC</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="anulacionForm">
                    <div class="mb-3">
                        <label for="motivoCancelacion" class="form-label">Motivo de la cancelación</label>
                        <textarea class="form-control" id="motivoCancelacion" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="usuarioNombre" class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="userName" value="@User.Identity?.Name" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="usuarioPassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="usuarioPassword" required>
                    </div>
                </form>

                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                <button type="button" class="btn btn-danger" id="confirmCancelarBtn">
                    <i class="fas fa-ban me-1"></i> Cancelar CxC
                </button>
            </div>
        </div>
    </div>
</div>